
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
dotenv.config({ path: '.env.local' });
const supabase = createClient(process.env.VITE_SUPABASE_URL!, process.env.VITE_SUPABASE_SERVICE_ROLE_KEY!);

const rawCsv = `프리드라이프,웅진프리드 360,실속형,3600000,24000,150,지도사1+도우미3,버스or리무진(택1),대마기계직+오동나무,한화리조트멤버십
프리드라이프,웅진프리드 450,표준형,4500000,30000,150,지도사1+도우미4,리무진+버스(왕복),대마수제+오동나무,크루즈/웨딩전환
프리드라이프,웅진프리드 540,고급형,5400000,36000,150,지도사2+도우미5,리무진+버스(왕복),대마수제+솔송나무,종합건강검진우대
대명스테이션,대명 라이프 297,실속형,2970000,16500,180,지도사1+도우미3,버스(왕복),대마기계직+오동나무,대명리조트멤버십
대명스테이션,대명 라이프 495,표준형,4950000,27500,180,지도사1+도우미4,리무진+버스(왕복),대마수제+오동나무,가전결합/전환서비스
대명스테이션,대명 라이프 594,고급형,5940000,33000,180,지도사2+도우미5,리무진+버스(왕복),저마수제+매장관,소노호텔VIP혜택
교원라이프,다드림 399,실속형,3990000,19950,200,지도사1+도우미3,버스+리무진(왕복),대마기계직+오동나무,호텔/여행할인
교원라이프,베스트라이프 499,표준형,4990000,24950,200,지도사1+도우미4,버스+리무진(왕복),대마수제+오동나무,교원그룹제휴혜택
교원라이프,베스트라이프 599,고급형,5990000,29950,200,지도사2+도우미5,버스+리무진(왕복),저마+매장관,교육상품전환가능
더케이예다함상조,예다함 390,실속형,3900000,26000,150,지도사2+도우미4,버스+리무진(왕복),대마기계직+오동나무,더케이호텔할인
더케이예다함상조,예다함 480,표준형,4800000,32000,150,지도사2+도우미6,버스+리무진(왕복),대마수제+오동나무,전국직영망
더케이예다함상조,예다함 550,고급형,5500000,36700,150,지도사2+도우미8,버스+리무진(왕복),저마+솔송나무,페이백시스템적용
보람상조,보람 프리미엄 390,실속형,3900000,30000,130,지도사2+도우미3,링컨리무진+버스,대마기계직+오동나무,사이버추모관
보람상조,보람 더베스트 499,표준형,4990000,35000,143,지도사2+도우미4,링컨리무진+버스,대마수제+오동나무,생체보석비아젬
보람상조,보람 로얄 580,고급형,5800000,30000,193,지도사2+도우미5,캐딜락리무진+버스,대마수제+솔송나무,고급장례용품
보람재향상조,재향 베이직 390,실속형,3900000,26000,150,지도사1+도우미3,버스+리무진,대마기계직+오동나무,재향군인회인프라
보람재향상조,재향 플래티넘 480,표준형,4800000,32000,150,지도사1+도우미4,리무진+버스(왕복),대마수제+오동나무,보람멤버십공유
보람재향상조,재향 VIP 540,고급형,5400000,36000,150,지도사2+도우미5,리무진+버스(왕복),저마+솔송나무,고급수의제공
JK상조,JK 360,실속형,3600000,24000,150,지도사1+도우미3,버스+리무진,대마기계직+오동나무,웨딩전환가능
JK상조,JK 450,표준형,4500000,30000,150,지도사1+도우미4,리무진+버스,대마수제+오동나무,고급수의업그레이드
JK상조,JK 540,고급형,5400000,36000,150,지도사2+도우미5,리무진+버스,저마+매장관,크루즈여행전환
늘곁애라이프,늘곁애 360,실속형,3600000,24000,150,지도사1+도우미3,버스+리무진,대마기계직+오동나무,부산경남특화
늘곁애라이프,늘곁애 420,표준형,4200000,28000,150,지도사1+도우미4,리무진+버스,대마수제+오동나무,직영장례식장할인
늘곁애라이프,늘곁애 540,고급형,5400000,36000,150,지도사2+도우미5,리무진+버스,저마+솔송나무,고인메이크업서비스
더리본,리본 390,실속형,3900000,26000,150,지도사1+도우미3,버스+리무진,대마기계직+오동나무,더파티뷔페연계
더리본,리본 450,표준형,4500000,30000,150,지도사1+도우미4,리무진+버스,대마수제+오동나무,웨딩/크루즈결합
더리본,리본 540,고급형,5400000,36000,150,지도사2+도우미5,리무진+버스,저마+매장관,토탈라이프케어
효원상조,효원 390,실속형,3900000,27800,140,지도사1+도우미3,버스+리무진,대마기계직+오동나무,전통의례강조
효원상조,효원 490,표준형,4900000,35000,140,지도사2+도우미4,리무진+버스,대마수제+오동나무,황실수의제공
효원상조,효원 590,고급형,5900000,42000,140,지도사2+도우미6,리무진+버스,저마+솔송나무,대규모빈소지원
한강라이프,한강 390,실속형,3900000,26000,150,지도사1+도우미3,버스+리무진,대마기계직+오동나무,크루즈여행전문
한강라이프,한강 450,표준형,4500000,30000,150,지도사1+도우미4,리무진+버스,대마수제+오동나무,회원멤버십혜택
한강라이프,한강 540,고급형,5400000,36000,150,지도사2+도우미5,리무진+버스,저마+솔송나무,VIP의전서비스
부모사랑,부모사랑 390,실속형,3900000,32500,120,지도사1+도우미3,버스+리무진,대마기계직+오동나무,고인메이크업특화
부모사랑,부모사랑 450,표준형,4500000,37500,120,지도사1+도우미4,리무진+버스,대마수제+오동나무,크루즈전환가능
부모사랑,부모사랑 560,고급형,5600000,46600,120,지도사2+도우미5,리무진+버스,저마+솔송나무,프리미엄추모서비스
평화상조,평화 360,실속형,3600000,24000,150,지도사1+도우미3,버스(왕복),대마기계직+오동나무,가톨릭특화서비스
평화상조,평화 420,표준형,4200000,28000,150,지도사1+도우미4,리무진+버스,대마수제+오동나무,미사예절지원
평화상조,평화 480,고급형,4800000,32000,150,지도사2+도우미5,리무진+버스,저마+매장관,연령회봉사지원
에스제이산림조합,SJ 숲 390,실속형,3900000,26000,150,지도사1+도우미3,버스+리무진,대마기계직+오동나무,산림조합제휴
에스제이산림조합,SJ 숲 480,표준형,4800000,32000,150,지도사1+도우미5,리무진+버스,대마수제+오동나무,수목장연계서비스
에스제이산림조합,SJ 숲 540,고급형,5400000,36000,150,지도사2+도우미6,리무진+버스,저마+솔송나무,장지할인혜택
현대에스라이프,현대 360,실속형,3600000,30000,120,지도사1+도우미3,버스+리무진,대마기계직+오동나무,대구경북기반
현대에스라이프,현대 450,표준형,4500000,37500,120,지도사1+도우미4,리무진+버스,대마수제+오동나무,지역제휴할인
현대에스라이프,현대 540,고급형,5400000,45000,120,지도사2+도우미5,리무진+버스,저마+솔송나무,고급의전차량
용인공원라이프,용인 390,실속형,3900000,26000,150,지도사1+도우미3,버스+리무진,대마기계직+오동나무,용인공원묘지연계
용인공원라이프,용인 480,표준형,4800000,32000,150,지도사1+도우미4,리무진+버스,대마수제+오동나무,봉안당우대
용인공원라이프,용인 550,고급형,5500000,36700,150,지도사2+도우미5,리무진+버스,저마+솔송나무,프리미엄장지서비스
좋은라이프,좋은 390,실속형,3900000,26000,150,지도사1+도우미3,버스+리무진,대마기계직+오동나무,프리드계열혜택
좋은라이프,좋은 450,표준형,4500000,30000,150,지도사1+도우미4,리무진+버스,대마수제+오동나무,전환서비스가능
좋은라이프,좋은 540,고급형,5400000,36000,150,지도사2+도우미5,리무진+버스,저마+솔송나무,VIP토탈케어
우리가족상조,우리 360,실속형,3600000,24000,150,지도사1+도우미3,버스+리무진,대마기계직+오동나무,기본상조서비스
우리가족상조,우리 420,표준형,4200000,28000,150,지도사1+도우미4,리무진+버스,대마수제+오동나무,고급장례용품
우리가족상조,우리 540,고급형,5400000,36000,150,지도사2+도우미5,리무진+버스,저마+솔송나무,VIP의전지원
다온플랜,다온 390,실속형,3900000,26000,150,지도사1+도우미3,버스+리무진,대마기계직+오동나무,표준장례서비스
다온플랜,다온 450,표준형,4500000,30000,150,지도사1+도우미4,리무진+버스,대마수제+오동나무,토탈장례케어
다온플랜,다온 540,고급형,5400000,36000,150,지도사2+도우미5,리무진+버스,저마+솔송나무,프리미엄서비스
금강문화허브,금강 360,실속형,3600000,24000,150,지도사1+도우미3,버스+리무진,대마기계직+오동나무,실속형구성
금강문화허브,금강 420,표준형,4200000,28000,150,지도사1+도우미4,리무진+버스,대마수제+오동나무,고급형구성
금강문화허브,금강 540,고급형,5400000,36000,150,지도사2+도우미5,리무진+버스,저마+솔송나무,VIP장례지원
제주상조,제주 330,실속형,3300000,27500,120,지도사1+도우미3,버스(도내),대마기계직+오동나무,제주지역맞춤
제주상조,제주 390,표준형,3900000,32500,120,지도사1+도우미4,버스+리무진,대마수제+오동나무,도내이송무료
제주상조,제주 480,고급형,4800000,40000,120,지도사2+도우미5,버스+리무진,저마+솔송나무,도외이송지원
대노복지사업단,대노 360,실속형,3600000,24000,150,지도사1+도우미3,버스+리무진,대마기계직+오동나무,대한노인회연계
대노복지사업단,대노 420,표준형,4200000,28000,150,지도사1+도우미4,리무진+버스,대마수제+오동나무,노인복지혜택
대노복지사업단,대노 540,고급형,5400000,36000,150,지도사2+도우미5,리무진+버스,저마+솔송나무,고급수의업그레이드
한라상조,한라 390,실속형,3900000,26000,150,지도사1+도우미3,버스+리무진,대마기계직+오동나무,전통상조서비스
한라상조,한라 480,표준형,4800000,32000,150,지도사1+도우미4,리무진+버스,대마수제+오동나무,프리미엄용품
한라상조,한라 550,고급형,5500000,36700,150,지도사2+도우미5,리무진+버스,저마+솔송나무,VIP의전케어
디에스라이프,DS 360,실속형,3600000,24000,150,지도사1+도우미3,버스+리무진,대마기계직+오동나무,대구지역특화
디에스라이프,DS 420,표준형,4200000,28000,150,지도사1+도우미4,리무진+버스,대마수제+오동나무,웨딩전환가능
디에스라이프,DS 540,고급형,5400000,36000,150,지도사2+도우미5,리무진+버스,저마+솔송나무,고급차량지원
위드라이프,위드 390,실속형,3900000,32500,120,지도사1+도우미3,버스+리무진,대마기계직+오동나무,줄기세포보관
위드라이프,위드 480,표준형,4800000,40000,120,지도사1+도우미4,리무진+버스,대마수제+오동나무,헬스케어결합
위드라이프,위드 540,고급형,5400000,45000,120,지도사2+도우미5,리무진+버스,저마+솔송나무,VIP줄기세포서비스
바라밀,바라밀 360,실속형,3600000,24000,150,지도사1+도우미3,버스+리무진,대마기계직+오동나무,불교장례특화
바라밀,바라밀 450,표준형,4500000,30000,150,지도사1+도우미4,리무진+버스,대마수제+오동나무,스님시다림
바라밀,바라밀 540,고급형,5400000,36000,150,지도사2+도우미5,리무진+버스,저마+솔송나무,49재상차림지원
우상조,우 360,실속형,3600000,30000,120,지도사1+도우미3,버스+리무진,대마기계직+오동나무,기본형서비스
우상조,우 420,표준형,4200000,35000,120,지도사1+도우미4,리무진+버스,대마수제+오동나무,표준형서비스
우상조,우 540,고급형,5400000,45000,120,지도사2+도우미5,리무진+버스,저마+솔송나무,고급형서비스
두레문화,두레 390,실속형,3900000,32500,120,지도사1+도우미3,버스+리무진,대마기계직+오동나무,협동조합형
두레문화,두레 450,표준형,4500000,37500,120,지도사1+도우미4,리무진+버스,대마수제+오동나무,조합원혜택
두레문화,두레 540,고급형,5400000,45000,120,지도사2+도우미5,리무진+버스,저마+솔송나무,VIP조합원서비스
불국토,불국토 390,실속형,3900000,26000,150,지도사1+도우미3,버스+리무진,대마기계직+오동나무,불교식장례
불국토,불국토 450,표준형,4500000,30000,150,지도사1+도우미4,리무진+버스,대마수제+오동나무,연화장지원
불국토,불국토 540,고급형,5400000,36000,150,지도사2+도우미5,리무진+버스,저마+솔송나무,불교장례VIP
태양상조,태양 350,실속형,3500000,29000,120,지도사1+도우미3,버스,대마기계직+오동나무,실속장례
태양상조,태양 420,표준형,4200000,35000,120,지도사1+도우미4,리무진+버스,대마수제+오동나무,표준장례
태양상조,태양 540,고급형,5400000,45000,120,지도사2+도우미5,리무진+버스,저마+솔송나무,고급장례
아주상조,아주 380,실속형,3800000,31000,120,지도사1+도우미3,버스+리무진,대마기계직+오동나무,기본의전
아주상조,아주 450,표준형,4500000,37500,120,지도사1+도우미4,리무진+버스,대마수제+오동나무,고급의전
아주상조,아주 540,고급형,5400000,45000,120,지도사2+도우미5,리무진+버스,저마+솔송나무,VIP의전
대한공무원상조,공무원 390,실속형,3900000,26000,150,지도사1+도우미3,버스+리무진,대마기계직+오동나무,공무원우대
대한공무원상조,공무원 450,표준형,4500000,30000,150,지도사1+도우미4,리무진+버스,대마수제+오동나무,제휴시설할인
대한공무원상조,공무원 540,고급형,5400000,36000,150,지도사2+도우미5,리무진+버스,저마+솔송나무,VIP공무원서비스
매일상조,매일 360,실속형,3600000,30000,120,지도사1+도우미3,버스,대마기계직+오동나무,가정의례전문
매일상조,매일 420,표준형,4200000,35000,120,지도사1+도우미4,리무진+버스,대마수제+오동나무,종합장례서비스
매일상조,매일 540,고급형,5400000,45000,120,지도사2+도우미5,리무진+버스,저마+솔송나무,고품격장례
삼성개발,삼성 390,실속형,3900000,26000,150,지도사1+도우미3,버스+리무진,대마기계직+오동나무,묘지조성연계
삼성개발,삼성 450,표준형,4500000,30000,150,지도사1+도우미4,리무진+버스,대마수제+오동나무,석재공사할인
삼성개발,삼성 540,고급형,5400000,36000,150,지도사2+도우미5,리무진+버스,저마+솔송나무,VIP석재공사
크리스찬상조,크리스찬 390,실속형,3900000,26000,150,지도사1+도우미3,버스+리무진,대마기계직+오동나무,기독교식장례
크리스찬상조,크리스찬 450,표준형,4500000,30000,150,지도사1+도우미4,리무진+버스,대마수제+오동나무,예배지원
크리스찬상조,크리스찬 540,고급형,5400000,36000,150,지도사2+도우미5,리무진+버스,저마+솔송나무,추모예배지원
대전상조,대전 350,실속형,3500000,29000,120,지도사1+도우미3,버스,대마기계직+오동나무,대전충청기반
대전상조,대전 420,표준형,4200000,35000,120,지도사1+도우미4,리무진+버스,대마수제+오동나무,지역할인
대전상조,대전 540,고급형,5400000,45000,120,지도사2+도우미5,리무진+버스,저마+솔송나무,VIP지역의전
전국공무원상조,전공 390,실속형,3900000,26000,150,지도사1+도우미3,버스+리무진,대마기계직+오동나무,공직자서비스
전국공무원상조,전공 450,표준형,4500000,30000,150,지도사1+도우미4,리무진+버스,대마수제+오동나무,퇴직자우대
전국공무원상조,전공 540,고급형,5400000,36000,150,지도사2+도우미5,리무진+버스,저마+솔송나무,VIP공직자의전
유토피아퓨처,유토피아 390,실속형,3900000,32500,120,지도사1+도우미3,버스+리무진,대마기계직+오동나무,안성유토피아연계
유토피아퓨처,유토피아 480,표준형,4800000,40000,120,지도사1+도우미4,리무진+버스,대마수제+오동나무,봉안당특별분양
유토피아퓨처,유토피아 580,고급형,5800000,48300,120,지도사2+도우미5,리무진+버스,저마+솔송나무,VIP추모관서비스
다나상조,다나 360,실속형,3600000,30000,120,지도사1+도우미3,버스,대마기계직+오동나무,기본장례
다나상조,다나 420,표준형,4200000,35000,120,지도사1+도우미4,리무진+버스,대마수제+오동나무,표준장례
다나상조,다나 540,고급형,5400000,45000,120,지도사2+도우미5,리무진+버스,저마+솔송나무,고급의전서비스`;

interface SangjoProduct {
    name: string;
    price: number;
    badges: string[];
    description: string;
    serviceDetails: Record<string, any>[];
}

interface CompanyData {
    products: SangjoProduct[];
}

function parseAndGroup(csv: string) {
    const lines = csv.trim().split('\n');
    const grouped: Record<string, CompanyData> = {};

    for (const line of lines) {
        if (!line.trim()) continue;
        const cols = line.split(',').map(s => s.trim());
        if (cols.length < 10) continue;

        const [company, productName, type, priceStr, monthlyPrice, terms, staff, bus, supplies, benefit] = cols;

        const price = parseInt(priceStr, 10);
        const monthly = parseInt(monthlyPrice, 10);
        const termCount = parseInt(terms, 10);

        const product: SangjoProduct = {
            name: productName,
            price: price,
            badges: [type],
            description: `월 ${monthly.toLocaleString()}원 × ${termCount}회`,
            serviceDetails: [
                { category: "인력", items: [staff] },
                { category: "차량", items: [bus] },
                { category: "용품", items: [supplies] },
                { category: "혜택", items: [benefit] }
            ]
        };

        // Rename correction for '더케이예다함상조' -> '더케이예다함' if needed to match DB
        let targetCompany = company;
        if (targetCompany === '더케이예다함상조') targetCompany = '더케이예다함';

        if (!grouped[targetCompany]) {
            grouped[targetCompany] = { products: [] };
        }
        grouped[targetCompany].products.push(product);
    }

    return grouped;
}

async function run() {
    const groupedData = parseAndGroup(rawCsv);
    console.log(`Parsed ${Object.keys(groupedData).length} unique companies.`);

    let inserted = 0;
    let updated = 0;

    for (const [companyName, data] of Object.entries(groupedData)) {
        // 1. Check if exists
        const { data: existing } = await supabase
            .from('memorial_spaces')
            .select('id, price_info')
            .eq('name', companyName)
            .eq('type', 'sangjo')
            .maybeSingle();

        const priceInfo = { products: data.products };

        if (existing) {
            // Update
            // console.log(`Updating ${companyName}...`);
            await supabase
                .from('memorial_spaces')
                .update({ price_info: priceInfo })
                .eq('id', existing.id);
            updated++;
        } else {
            // Insert
            // console.log(`Inserting New ${companyName}...`);
            const { error: insertError } = await supabase
                .from('memorial_spaces')
                .insert({
                    name: companyName,
                    type: 'sangjo',
                    address: '전국 서비스', // Default
                    lat: 37.5665, // Default Seoul
                    lng: 126.9780,
                    price_info: priceInfo,
                    is_verified: true,
                    price_range: '문의' // Use price_range instead of priceRange
                });

            if (insertError) {
                console.error(`FAILED to insert ${companyName}:`, insertError.message);
            } else {
                inserted++;
            }
        }
    }

    console.log('------------------------------------------------');
    console.log(`✅ Job Complete.`);
    console.log(`Updated: ${updated} companies`);
    console.log(`New Inserted: ${inserted} companies`);
}

run();
