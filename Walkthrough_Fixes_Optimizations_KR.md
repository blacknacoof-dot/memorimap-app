# 워크스루 - 수정 및 최적화 (Fixes & Optimizations)

이 워크스루는 지도 마커 겹침 현상과 카테고리 필터 문제를 해결하기 위해 진행된 변경 사항을 자세히 설명합니다.

## 1. 문제점 (Problem)
- **마커 겹침 (Marker Clumping)**: 여러 시설이 동일한 좌표를 공유하고 있어, 마커가 완벽하게 겹쳐 클릭할 수 없는 문제가 발생했습니다.
- **필터 문제 (Filter Issues)**: 프론트엔드에서는 한글 값('장례식장' 등)을 기대했으나, 데이터베이스에는 영문 또는 혼용된 값이 있어 카테고리 필터가 작동하지 않았습니다.
- **데이터 문제 (Data Issues)**: `category` 컬럼이 엄격한 ENUM 타입으로 되어 있어 업데이트 시 에러가 발생했으며, 좌표 컬럼명이 일관되지 않았습니다 (`lat`/`lng` 대 `latitude`/`longitude`).

## 2. 구현된 해결책 (Solution Implemented)

### 데이터 표준화 (마이그레이션 v6.2)
- **안전한 타입 변환**: ENUM 에러 방지를 위해 `category` 컬럼을 `TEXT` 타입으로 변환했습니다.
- **영문 코드 표준화**: 모든 카테고리 값을 영문 Enum 코드(예: `funeral_home`, `columbarium`)로 표준화했습니다.
- **좌표 지터링 (Coordinate Jitter)**: 윈도우 함수(window functions)를 사용하여 계산된 작은 오프셋을 추가함으로써 중복된 좌표의 마커를 분산시켰습니다.
- **자동 감지**: 좌표 컬럼명(`lat` 대 `latitude`)을 동적으로 감지하여 에러를 방지했습니다.
- **클린업 (Cleanup)**: 위치 데이터가 누락된 시설에 기본 좌표를 할당하고 성능 향상을 위한 인덱스를 추가했습니다.

### 프론트엔드 업데이트
| 컴포넌트 | 변경 사항 |
|-----------|--------|
| `types/facility.ts` | **업데이트됨**: `Facility` 타입이 이제 `lat`/`lng`을 우선시하며 표준화된 카테고리를 사용합니다. |
| `hooks/useFacilities.ts` | **업데이트됨**: 호환성을 위해 `.select('*, latitude:lat, longitude:lng')` 별칭(alias)을 사용하여 쿼리하며, 카테고리를 정규화합니다. |
| `CategoryFilter.tsx` | **업데이트됨**: 화면에는 한글 라벨을 표시하지만 내부적으로는 영문 코드를 사용합니다. |
| `MapView.tsx` | **업데이트됨**: 필터 로직이 이제 표준화된 영문 코드를 기준으로 확인합니다. |
| `App.tsx` | **업데이트됨**: RPC 서명 불일치(`user_lat`/`user_lng`)를 수정하고 `Facility` 타입 속성(`facility_type`, `latitude`)을 일치시켰습니다. |

### RPC 수정 (마이그레이션 v6.5)
- **문제**: `search_facilities` RPC가 오래된 `location` 컬럼이나 모호한 `lat`/`lng` 키를 사용하여 `PGRST202` 에러를 유발했습니다.
- **해결**: RPC가 `user_lat`/`user_lng` 파라미터를 명시적으로 허용하고, 정확한 거리 계산을 위해 새로운 숫자형 `lat`/`lng` 컬럼을 사용하도록 업데이트했습니다.

### 데이터 클리닝 (마이그레이션 v6.6)
- **문제**: 초기 마이그레이션 과정에서 시설들이 잘못 분류되었습니다 (예: 공원이 'funeral_home'으로 기본 설정됨).
- **해결**: 시설 이름의 한글 키워드를 기반으로 재분류했습니다 (예: '공원' -> `cemetery`, '봉안' -> `columbarium`).
- **결과**: 카테고리 분포가 균형 있게 조정되었음을 확인했습니다 (묘지: 약 555개, 봉안당: 약 196개 등).

## 3. 검증 통과 (Verification Passed)
SQL 마이그레이션(`v6.2`, `v6.5`, `v6.6`)과 검증 스크립트가 성공적으로 실행되었습니다.
- **좌표 고유성**: 95% 이상 확인됨.
- **카테고리**: 모두 영문 코드로 정규화됨.
- **프론트엔드 통합**: `useFacilities.ts`에 엄격한 컬럼 별칭을 포함하여 지도 에러를 방지함.

## 4. 최종 시각적 확인 (Final Visual Check)
1. **강력 새로고침**: 브라우저에서 `Ctrl+Shift+R`을 누르세요.
2. **마커**: 마커들이 분산되어 구별 가능해야 합니다.
3. **필터**: "장례식장", "봉안시설" 등을 클릭했을 때 지도가 올바르게 필터링되어야 합니다.
