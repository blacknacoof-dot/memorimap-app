<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>장례식장 AI 상담사 테스트</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap');

        body {
            font-family: 'Noto Sans KR', sans-serif;
        }

        /* Custom Scrollbar */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Message Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-enter {
            animation: fadeIn 0.3s ease-out forwards;
        }

        /* Typing Indicator */
        .typing-dot {
            animation: typing 1.4s infinite ease-in-out both;
        }

        .typing-dot:nth-child(1) {
            animation-delay: -0.32s;
        }

        .typing-dot:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes typing {

            0%,
            80%,
            100% {
                transform: scale(0);
            }

            40% {
                transform: scale(1);
            }
        }
    </style>
</head>

<body class="bg-slate-100 h-screen flex items-center justify-center p-4">

    <!-- Main Container -->
    <div
        class="bg-white w-full max-w-[420px] h-[750px] rounded-3xl shadow-2xl flex flex-col overflow-hidden relative border border-slate-200">

        <!-- Header -->
        <div class="bg-slate-900 text-white p-5 pt-6 shadow-md z-10">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-3">
                    <div class="relative">
                        <div
                            class="w-12 h-12 rounded-full bg-slate-700 flex items-center justify-center border-2 border-slate-500 overflow-hidden">
                            <i data-lucide="user" class="w-6 h-6 text-slate-300"></i>
                        </div>
                        <span
                            class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 border-2 border-slate-900 rounded-full"></span>
                    </div>
                    <div>
                        <h1 class="font-bold text-lg leading-tight">평안 장례식장</h1>
                        <p class="text-xs text-slate-400 flex items-center gap-1">
                            <i data-lucide="sparkles" class="w-3 h-3 text-yellow-400"></i>
                            AI 의전 매니저 연결됨
                        </p>
                    </div>
                </div>
                <button class="p-2 hover:bg-slate-800 rounded-full transition-colors" title="상담 종료">
                    <i data-lucide="x" class="w-5 h-5 text-slate-400"></i>
                </button>
            </div>

            <!-- Quick Info Badge -->
            <div class="flex gap-2 text-[11px] font-medium">
                <span class="bg-slate-800 px-2 py-1 rounded text-slate-300">24시간 상담</span>
                <span class="bg-slate-800 px-2 py-1 rounded text-slate-300">빈소 현황 확인</span>
            </div>
        </div>

        <!-- Chat Area -->
        <div id="chat-container" class="flex-1 bg-slate-50 p-4 overflow-y-auto scrollbar-hide space-y-4 pb-20">
            <!-- Messages will be injected here -->
        </div>

        <!-- Input Area -->
        <div class="absolute bottom-0 left-0 w-full bg-white border-t border-slate-100 p-4 pb-6">
            <div class="flex gap-2 items-end">
                <div
                    class="flex-1 bg-slate-100 rounded-2xl border border-transparent focus-within:border-slate-300 focus-within:bg-white transition-all px-4 py-3">
                    <textarea id="user-input" rows="1" placeholder="궁금하신 점을 말씀해주세요..."
                        class="w-full bg-transparent border-none focus:outline-none text-sm resize-none max-h-24 py-1"
                        oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'"
                        onkeypress="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); }"></textarea>
                </div>
                <button onclick="sendMessage()" id="send-btn"
                    class="w-12 h-12 bg-slate-900 text-white rounded-full flex items-center justify-center shadow-lg hover:bg-slate-800 active:scale-95 transition-all disabled:bg-slate-300 disabled:cursor-not-allowed">
                    <i data-lucide="send" class="w-5 h-5 ml-0.5"></i>
                </button>
            </div>
            <div class="text-center mt-2">
                <p class="text-[10px] text-slate-400">Gemini 2.5 Flash 모델이 답변합니다.</p>
            </div>
        </div>

    </div>

    <script>
        // --- 1. MOCK DATA (장례식장 설정) ---
        const FACILITY_DATA = {
            name: "평안 장례식장",
            address: "서울시 서초구 평안로 123",
            tel: "02-1234-5678",
            facility_type: "FUNERAL_HOME", // 장례식장 타입
            ai_tone: "polite", // 정중한 톤
            ai_context: "현재 VIP실(80평)과 특실(50평)이 이용 가능하며, 일반실은 만실입니다. 주차장은 건물 지하 1~3층에 500대 수용 가능하며 상주는 무료입니다. 식사는 1인분 18,000원입니다.",
            ai_price_summary: {
                "VIP실(1일)": "150만원",
                "특실(1일)": "100만원",
                "일반실(1일)": "60만원",
                "안치료(1일)": "10만원"
            }
        };

        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');

        let chatHistory = []; // 대화 기록 저장용

        // --- 2. 초기화 ---
        window.onload = () => {
            lucide.createIcons();
            // 웰컴 메시지 (DB 설정값 시뮬레이션)
            addMessage("ai", "삼가 고인의 명복을 빕니다. 평안 장례식장 의전 매니저입니다. <br>무엇을 도와드릴까요?", "NONE");
        };

        // --- 3. 메시지 UI 처리 함수 ---
        function addMessage(sender, text, action = 'NONE') {
            const div = document.createElement('div');
            const isUser = sender === 'user';

            div.className = `flex w-full message-enter ${isUser ? 'justify-end' : 'justify-start'}`;

            let contentHtml = text.replace(/\n/g, '<br>');

            // 액션 버튼 추가 로직
            let actionButtonHtml = '';
            if (!isUser && action !== 'NONE') {
                if (action === 'RESERVE') {
                    actionButtonHtml = `
                        <button onclick="handleAction('RESERVE')" class="mt-3 w-full bg-slate-800 text-white text-xs py-2.5 px-3 rounded-lg flex items-center justify-center gap-2 hover:bg-slate-700 transition">
                            <i data-lucide="calendar-check" class="w-4 h-4"></i> 빈소 예약 상담 접수
                        </button>`;
                } else if (action === 'MAP') {
                    actionButtonHtml = `
                        <button onclick="handleAction('MAP')" class="mt-3 w-full bg-slate-100 text-slate-700 text-xs py-2.5 px-3 rounded-lg flex items-center justify-center gap-2 hover:bg-slate-200 transition border border-slate-200 font-medium">
                            <i data-lucide="map-pin" class="w-4 h-4"></i> 오시는 길 보기
                        </button>`;
                } else if (action === 'CALL_MANAGER') {
                    actionButtonHtml = `
                        <button onclick="handleAction('CALL_MANAGER')" class="mt-3 w-full bg-red-50 text-red-600 text-xs py-2.5 px-3 rounded-lg flex items-center justify-center gap-2 hover:bg-red-100 transition border border-red-100 font-medium">
                            <i data-lucide="phone-call" class="w-4 h-4"></i> 장례지도사 긴급 연결
                        </button>`;
                }
            }

            const bubbleClass = isUser
                ? 'bg-slate-800 text-white rounded-2xl rounded-tr-sm'
                : 'bg-white text-slate-800 border border-slate-200 rounded-2xl rounded-tl-sm shadow-sm';

            div.innerHTML = `
                <div class="max-w-[85%] ${bubbleClass} p-4 text-sm leading-relaxed">
                    ${contentHtml}
                    ${actionButtonHtml}
                </div>
            `;

            chatContainer.appendChild(div);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            lucide.createIcons(); // 아이콘 새로고침
        }

        function showLoading() {
            const div = document.createElement('div');
            div.id = 'loading-indicator';
            div.className = 'flex justify-start message-enter';
            div.innerHTML = `
                <div class="bg-white border border-slate-200 rounded-2xl rounded-tl-sm p-4 shadow-sm flex gap-1.5 items-center">
                    <div class="w-1.5 h-1.5 bg-slate-400 rounded-full typing-dot"></div>
                    <div class="w-1.5 h-1.5 bg-slate-400 rounded-full typing-dot"></div>
                    <div class="w-1.5 h-1.5 bg-slate-400 rounded-full typing-dot"></div>
                </div>
            `;
            chatContainer.appendChild(div);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function removeLoading() {
            const loader = document.getElementById('loading-indicator');
            if (loader) loader.remove();
        }

        function handleAction(type) {
            // 실제 앱에서는 모달을 띄우거나 페이지를 이동시킵니다.
            if (type === 'RESERVE') alert("[시스템] 빈소 예약 신청 모달이 열립니다.");
            if (type === 'MAP') alert(`[시스템] 지도 앱을 엽니다.\n주소: ${FACILITY_DATA.address}`);
            if (type === 'CALL_MANAGER') location.href = `tel:${FACILITY_DATA.tel}`;
        }

        // --- 4. Gemini API 로직 (geminiService.ts 이식) ---
        async function sendMessage() {
            const text = userInput.value.trim();
            if (!text) return;

            addMessage('user', text);
            userInput.value = '';
            userInput.style.height = 'auto'; // 높이 초기화
            sendBtn.disabled = true;

            showLoading();

            try {
                // 1. 프롬프트 구성 (geminiService.ts의 buildSystemPrompt 로직)
                const systemPrompt = buildSystemPrompt(FACILITY_DATA);

                // 2. API 호출
                const apiKey = ""; // API Key injected by environment
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [
                            {
                                role: "user",
                                parts: [{
                                    text: `
                                    ${systemPrompt}
                                    
                                    [이전 대화 내역 (Context)]
                                    ${chatHistory.map(m => `${m.role}: ${m.text}`).join('\n')}
                                    
                                    [사용자 질문]
                                    ${text}
                                `}]
                            }
                        ]
                    })
                });

                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error.message);
                }

                const rawText = data.candidates[0].content.parts[0].text;

                // 3. 응답 파싱 (geminiService.ts의 태그 파싱 로직)
                let action = 'NONE';
                let cleanText = rawText;

                if (rawText.includes('<ACTION:RESERVE>')) {
                    action = 'RESERVE';
                    cleanText = rawText.replace('<ACTION:RESERVE>', '');
                } else if (rawText.includes('<ACTION:MAP>')) {
                    action = 'MAP';
                    cleanText = rawText.replace('<ACTION:MAP>', '');
                } else if (rawText.includes('<ACTION:CALL_MANAGER>')) {
                    action = 'CALL_MANAGER';
                    cleanText = rawText.replace('<ACTION:CALL_MANAGER>', '');
                } else {
                    cleanText = rawText.replace('<ACTION:NONE>', '');
                }

                // 대화 기록 업데이트 (최근 5개만 유지)
                chatHistory.push({ role: 'user', text: text });
                chatHistory.push({ role: 'model', text: cleanText }); // rawText 대신 cleanText 저장
                if (chatHistory.length > 10) chatHistory = chatHistory.slice(-10);

                removeLoading();
                addMessage('ai', cleanText.trim(), action);

            } catch (error) {
                console.error("API Error:", error);
                removeLoading();
                addMessage('ai', "죄송합니다. 잠시 시스템 오류가 발생했습니다. 담당자를 연결해 드리겠습니다.", 'CALL_MANAGER');
            } finally {
                sendBtn.disabled = false;
                userInput.focus();
            }
        }

        // --- 5. 시스템 프롬프트 빌더 (로직 복사) ---
        function buildSystemPrompt(facility) {
            const { name, address, facility_type, ai_tone, ai_context, ai_price_summary } = facility;

            // 톤앤매너
            let toneInstruction = "당신은 호텔 컨시어지처럼 매우 정중하고 격식 있는 존댓말(하십시오체)을 사용합니다.";

            // 역할
            let roleInstruction = "당신은 장례식장의 의전 매니저입니다. 고객은 경황이 없는 상태이므로, 신속하게 빈소 현황과 절차를 안내해야 합니다.";

            // 가격 포매팅
            const priceInfo = Object.entries(ai_price_summary)
                .map(([item, price]) => `- ${item}: ${price}`)
                .join("\n");

            return `
                당신은 '${name}'의 AI 상담사입니다.
                
                [당신의 역할]
                ${roleInstruction}
                ${toneInstruction}

                [시설 필수 정보 (Knowledge Base)]
                - 주소: ${address}
                - 시설 상세 정보/특징: ${ai_context}
                - 가격/비용 정보:
                ${priceInfo}

                [행동 지침 (Action Protocol)]
                사용자의 질문 의도를 파악하여 답변 끝에 반드시 다음 태그 중 하나를 붙이세요. (태그는 사용자에게 보이지 않게 처리됩니다)
                1. 사용자가 방문 상담이나 장례 예약(빈소 예약)을 원하면: <ACTION:RESERVE>
                2. 사용자가 위치, 가는 길, 지도를 물어보면: <ACTION:MAP>
                3. 사용자가 담당자와 직접 통화하고 싶어하거나 긴급 상황(운구차 필요 등)이면: <ACTION:CALL_MANAGER>
                4. 그 외 일반적인 대화: <ACTION:NONE>

                [주의 사항]
                - 답변은 3문장 이내로 핵심만 전달하세요.
                - 할루시네이션 방지: 없는 정보를 지어내지 마세요.
            `;
        }
    </script>
</body>

</html>